<!DOCTYPE html>
<html>
    <head>
        
    </head>
    <body style="margin: 0;">
        <div id="monitor" style="border: solid black"></div>

        <script type="text/javascript" src="https://rawgithub.com/craftyjs/Crafty/release/dist/crafty-min.js"></script>
        

        <!-- Script zum Herumprobieren (nich Commiten bzw. Pushen) -->
        <script>
            // Var - f체r alle Spiele relevant
            let zeitStart;
            let punkte = 0;
            const HINTERGRUND = {w: 4800, h: 3600};
            const MONITOR = {w: window.innerWidth - 10, h: window.innerHeight - 10};
            let gammaInit;
            let betaInit;
            let charakter;
            // let alphaInit;
            // Var - nur f체r J채germeister
            
            
            
            let zielAktuell;
            const DAEMPFUNG_FADENKREUZ = 5;
            const Jaegermeister = {
                initialisiere() {
                    // Szene Start
                    Crafty.scene('startbildschirm', () => {
                        Crafty.e('2D, Canvas, Text')
                            .attr({x: 10, y: 10, })
                            .text(() => {return 'J채germeister feat. Susi'});

                        Crafty.e('2D, Canvas, Mouse, Color')
                            .attr({x: 10, y: 50, w: 100, h: 50})
                            .color('red')
                            .bind('Click', () => {
                                zeitStart = Date.now()
                                Crafty.scene('spiel')}
                            )
                    })
                    // Szene Spiel
                    Crafty.scene('spiel', () => {
                        // Hintergrund
                        Crafty.e('2D, Canvas, Image')
                            .attr({w: HINTERGRUND.w, h: HINTERGRUND.h, z: 0})
                            .image('./jaegermeister/wald_4x.jpg')
                        
                        // Ziel
                        Crafty.e('2D, Canvas, Color, Ziel, Motion, Particles')
                            .color('red')
                            .attr({x: 0, y: 30, w: 300, h: 300, vx: 300})
                            // .bind('UpdateFrame', function() {
                            //     if (this.x > HINTERGRUND.w - this.w) {
                            //         this.vx *= -1;
                            //     } else {
                            //         console.log('HINTERGRUND.w - this.x:', HINTERGRUND.w - this.x);
                            //     }
                            // })

                        // Fadenkreuz
                        let zielpunkt = Crafty.e('2D, Canvas, Fadenkreuz, Collision')
                            .attr({x: MONITOR.w / 2, y: MONITOR.h / 2})
                            .bind('steuerung', function(evt) {
                                switch (evt.type) {
                                    case 'deviceorientation':
                                        gammaInit = gammaInit || evt.gamma;
                                        betaInit = betaInit || evt.beta;
                                        let gamma = evt.gamma - gammaInit;
                                        let beta = evt.beta - betaInit;
                                        let orientierung = MONITOR.w > MONITOR.h && 'quer' || 'hoch';
                                        this.x += orientierung == 'quer' ? gamma * DAEMPFUNG_FADENKREUZ : beta * DAEMPFUNG_FADENKREUZ;
                                        this.y += orientierung == 'quer' ? beta * DAEMPFUNG_FADENKREUZ : gamma * DAEMPFUNG_FADENKREUZ;
                                }
                            })
                            .checkHits('Ziel')
                            .bind('HitOn', (arrHitData) => {
                                zielAktuell = arrHitData[0].obj;
                                console.log('zielAktuell:', zielAktuell);
                            })
                            .bind('HitOff', (arrHitData) => {
                                zielAktuell = undefined;
                                console.log('zielAktuell:', zielAktuell);
                            });
                        
                        let fadenkreuz = Crafty.e('2D, Canvas, Image, Motion, Color')
                            .attr({w: 300, h: 300, x: zielpunkt.x - 150, y: zielpunkt.y - 150, z: 1})
                            .image('./jaegermeister/fadenkreuz_300.png')

                        zielpunkt.attach(fadenkreuz);
                        // let timer = Crafty.e('2D, Canvas, Text')
                        //     .attr({x: 0, y: 0})
                        //     .bind('UpdateFrame', function() {
                        //         let spielzeit = Date.now() - zeitStart;
                        //         if (spielzeit > 10000 ) {
                        //             Crafty.scene('endbildschirm');
                        //         } else {
                        //             this.text(() => {return spielzeit / 1000})
                        //         }
                        //     })

                        // zielpunkt.attach(timer);
                        Crafty.viewport.follow(zielpunkt);
                        Crafty.viewport.bounds = {min: {x: 0, y:0}, max:{x: HINTERGRUND.w, y: HINTERGRUND.h}};

                        // Steuerung
                        window.addEventListener('deviceorientation', evt => {zielpunkt.trigger('steuerung', evt)});
                        window.addEventListener('touchstart', evt => {
                            if (zielAktuell && !zielAktuell.istTot) {
                                punkte++;
                                console.log('punkte:', punkte);
                                zielAktuell.attr({rotation: 50, vy: 500}).istTot = true;
                            }
                        });
                    })
                    // Szene Ende
                    Crafty.scene('endbildschirm', () => {
                        Crafty.e('2D, Canvas, Text')
                            .attr({x: 10, y: 10})
                            .text(() => {return `Spielende. Punktezahl: ${punkte}`})
                        Crafty.e('2D, Canvas, Mouse, Color')
                            .color('red')
                            .attr({x: 10, y: 50, w: 100, h: 50})
                            .bind('Click', () => window.location = 'http://www.google.com')
                    })
                }
            }


            function erzeugeBoden(optionen) {
                Crafty.e('2D, Canvas, Color, Boden, SolidHitBox, Collision')
                    .attr({w: optionen.w, h: optionen.h, x:optionen.x , y: optionen.y, rotation: optionen.rotation})
                    .color('blue')
                    .checkHits('Charakter')
                    .bind('HitOn', (arrHitData) => {
                        hitData = arrHitData[0];
                        let charakter = hitData.obj;
                        charakter.flugphase = false;
                        charakter.ay = 0;
                        charakter.y -= Math.abs(hitData.ny * hitData.overlap);
                        charakter.vx = Math.cos(optionen.rotation * (Math.PI / 180)) * charakter.v;
                        charakter.vy = Math.sin(optionen.rotation * (Math.PI / 180)) * charakter.v;
                        console.log('charakter.rotation:', charakter.rotation);
                    })
                    .bind('HitOff', () => {
                        charakter.ay = A_GRAVITATION;
                        charakter.flugphase = true;
                    }) 
            }
            const V_CHARAKTER = 500;
            const A_GRAVITATION = 500;
            const DAEMPFUNG_DREHUNG = 1;
            const Heidenspass = {
                initialisiere() {
                    Crafty.scene('startbildschirm', () => {
                        erzeugeBoden({w: 10000, h: 1, x: 0, y: 300, rotation: 20});
                        erzeugeBoden({w: 10, h: 1, x: 400, y: 300 + Math.tan(20 * Math.PI / 180) * 400, rotation: -60});
                        erzeugeBoden({w: 10, h: 1, x: 1500, y: 300 + Math.tan(20 * Math.PI / 180) * 1500, rotation: -60});
                        erzeugeBoden({w: 10, h: 1, x: 3100, y: 300 + Math.tan(20 * Math.PI / 180) * 3100, rotation: -60});
                        

                        charakter = Crafty.e('2D, Canvas, Motion, Color, Collision, Image, Charakter')
                            .attr({w:33, h:100})
                            .image('./heidenspass/christian_stick_33_100.png')
                            .origin('center')
                            .bind('steuerung', function(evt) {
                                if (this.flugphase) {
                                    switch (evt.type) {
                                        case 'deviceorientation':
                                            gammaInit = gammaInit || evt.gamma;
                                            betaInit = betaInit || evt.beta;
                                            let gamma = evt.gamma - gammaInit;
                                            let beta = evt.beta - betaInit;
                                            let orientierung = MONITOR.w > MONITOR.h && 'quer' || 'hoch';
                                            this.rotation += orientierung == 'quer' ? gamma * DAEMPFUNG_DREHUNG : beta * DAEMPFUNG_DREHUNG;
                                            this.rotation += orientierung == 'quer' ? beta * DAEMPFUNG_DREHUNG : gamma * DAEMPFUNG_DREHUNG;
                                    }
                                }
                            })
                        charakter.v = V_CHARAKTER;
                        charakter.ay = A_GRAVITATION;

                        Crafty.viewport.follow(charakter);
                        Crafty.viewport.clampToEntities = false;

                        // Steuerung
                        window.addEventListener('deviceorientation', evt => {charakter.trigger('steuerung', evt)});

                    })
                }
            }

            function erzeugeSpiegel(optionen) {
                return Crafty.e('2D, Canvas, Image, Color, Ziel')
                    .attr({x: optionen.x, y: optionen.y, w: 10, h: 10})
                    .color('red');
            }

            const Spiegeltrinker = {
                initialisiere() {
                    Crafty.scene('spiel', function() {

                        // Hintergrund
                        let hintergrund = Crafty.e('2D, Canvas, Image, Color, Motion')
                            .attr({w: MONITOR.w * 10, h: MONITOR.h, z: 0})
                            .color('grey')
                            
                            .attach(erzeugeSpiegel({x: 500, y: 300}))
                            .attach(erzeugeSpiegel({x: 1500, y: 200}))
                            .attach(erzeugeSpiegel({x: 1500, y: 200}))
                            .attach(erzeugeSpiegel({x: 1500, y: 200}))
                            .attach(erzeugeSpiegel({x: 2000, y: 100}))
                            .attach(erzeugeSpiegel({x: 2500, y: 200}))
                            .attach(erzeugeSpiegel({x: 3000, y: 300}))
                            
                            //.image('./jaegermeister/wald_4x.jpg')
                            .vx = -500;
                            
                        // Ziel (Spiegel)

                        // Charakter (Auto)
                        Crafty.e('2D, Canvas, Image, Motion, Color, Charakter, Collision, Fourway')
                            .attr({x: 0, y: MONITOR.h/2 - 30/2, w: 50, h: 30})
                            .color('red')
                            .checkHits('Ziel')
                            .bind('HitOn', arrHitData => {
                                punkte += 1;
                                console.log('punkte:', punkte);
                                let spiegel = arrHitData[0].obj;
                                spiegel.destroy();
                            })
                            .bind('steuerung', evt => null)
                            .fourway(500)
                    }) 
                }
        }
            let mapSpiele = {jm: Jaegermeister, hs: Heidenspass, st: Spiegeltrinker};

            Crafty.init(MONITOR.w, MONITOR.h, document.querySelector('#monitor'));
            mapSpiele['st'].initialisiere();
            Crafty.scene('spiel');
        </script>
    </body>
</html>
